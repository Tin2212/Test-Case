{% extends 'base.html' %}

{% macro render_manual_list(text_block) %}
    <div class="manual-list">
        {% for line in (text_block or "").split('\n') if line.strip() %}
        <div class="manual-list-item">
            <span class="manual-list-number">{{ loop.index }}.</span>
            <span class="manual-list-text">{{ line.strip().lstrip('0123456789. ') }}</span>
        </div>
        {% endfor %}
    </div>
{% endmacro %}


{% block page_title %}
    測試案例列表
{% endblock %}

{% block sidebar %}
    <nav class="tree-nav">
        <ul>
            <li>
                <a href="{{ url_for('index') }}" class="{{ 'active-filter' if not selected_product }}">
                    <i class="bi bi-folder-fill me-2"></i>所有產品
                </a>
            </li>
            {% for product, main_categories in tree_data.items()|sort %}
                <li class="parent {% if product == selected_product %}active open{% endif %}">
                    <a href="{{ url_for('index', product=product) }}">
                        {{ product }}
                    </a>
                    <ul class="sub-menu">
                        {% for main_group, sub_groups in main_categories.items()|sort %}
                             <li class="parent {% if product == selected_product and main_group == selected_main_category %}active open{% endif %}">
                                <a href="{{ url_for('index', product=product, main_category=main_group) }}">
                                    {{ main_group }}
                                </a>
                                <ul class="sub-menu">
                                    {% for sub in sub_groups|sort %}
                                        <li>
                                            <a href="{{ url_for('index', product=product, main_category=main_group, sub_category=sub) }}"
                                               class="{{ 'active-filter' if product == selected_product and main_group == selected_main_category and sub == selected_sub_category }}">
                                                {{ sub }}
                                            </a>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </li>
                        {% endfor %}
                    </ul>
                </li>
            {% endfor %}
        </ul>
    </nav>
{% endblock %}

{% block content %}
    <h4 class="mb-3">
        {% if selected_sub_category %}
            {{ selected_product }} / {{ selected_main_category }} / {{ selected_sub_category }}
        {% elif selected_main_category %}
            {{ selected_product }} / {{ selected_main_category }}
        {% elif selected_product %}
            {{ selected_product }}
        {% else %}
            所有案例
        {% endif %}
        <span class="badge bg-light text-dark ms-2">{{ pagination.total }} 筆</span>
    </h4>

    {% if global_precondition %}
    <div class="alert alert-info" role="alert">
        <h6 class="alert-heading">
            <i class="bi bi-info-circle-fill me-2"></i>{{ selected_product }} - 全域前置條件
        </h6>
        <hr>
        <pre class="mb-0" style="font-family: inherit; font-size: inherit;">{{ global_precondition }}</pre>
    </div>
    {% endif %}

    <form id="bulk-action-form" action="{{ url_for('bulk_add_tag') }}" method="POST">
        
        {# --- 核心修改點：在這裡加上一個 div 並套用 sticky-bar class --- #}
        <div class="sticky-bar">
            <div class="card">
                <div class="card-body d-flex align-items-center gap-3">
                    <div class="input-group" style="max-width: 400px;">
                        <span class="input-group-text">標籤</span>
                        <input type="text" name="new_tag" class="form-control" required placeholder="輸入新標籤...">
                        <button type="submit" class="btn btn-primary">為選取項目套用</button>
                    </div>
                    <div class="ms-auto">
                        <button type="button" id="expand-all-btn" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-arrows-expand"></i> 全部展開
                        </button>
                        <button type="button" id="collapse-all-btn" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-arrows-collapse"></i> 全部收合
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <input type="hidden" name="product" value="{{ selected_product or '' }}">
        <input type="hidden" name="main_category" value="{{ selected_main_category or '' }}">
        <input type="hidden" name="sub_category" value="{{ selected_sub_category or '' }}">
        
        <div class="table-responsive">
            <table class="table table-hover table-bordered caption-top table-fixed-layout">
                <caption></caption>
                <thead class="table-dark">
                    <tr>
                        <th style="width: 3%;"><input class="form-check-input" type="checkbox" id="select-all-checkbox"></th>
                        <th style="width: 10%;">Case ID / 標籤</th>
                        <th style="width: 20%;">測試項目</th>
                        <th style="width: 32%;">狀態 / 實際結果</th>
                        <th style="width: 25%;">備註</th>
                        <th style="width: 10%;">操作</th>
                    </tr>
                </thead>
                {% for case in cases %}
                    <tbody class="case-group">
                        <tr class="expandable-row" data-bs-target="#collapse-{{ case.id }}" style="cursor: pointer;">
                            <td class="text-center align-middle">
                                <input class="form-check-input case-checkbox" type="checkbox" name="case_ids" value="{{ case.id }}">
                            </td>
                            <td>
                                {{ case.case_id }}
                                {% include 'partials/_tags_display.html' %}
                            </td>
                            <td>{{ case.test_item }}</td>
                            <td>
                                <div id="status-result-wrapper-{{ case.id }}">
                                    {% include 'partials/_status_result_display.html' %}
                                </div>
                            </td>
                            <td>
                                <div id="notes-wrapper-{{ case.id }}">
                                    {% include 'partials/_notes_display.html' %}
                                </div>
                            </td>
                            <td>
                                <div class="dropdown">
                                    <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">操作</button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{{ url_for('edit_case', id=case.id) }}">完整編輯</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <form action="{{ url_for('delete_case', id=case.id) }}" method="POST" onsubmit="return confirm('您確定要刪除這個案例嗎？');">
                                                <button type="submit" class="dropdown-item text-danger">刪除</button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        <tr id="collapse-{{ case.id }}" class="collapse">
                           <td colspan="6" style="background-color: #f8f9fa; padding: 20px;">
                                <div class="row g-3">
                                     <div class="col-md-6">
                                        <strong>測試目的:</strong>
                                        <p style="white-space: pre-wrap; margin-bottom: 0;">{{ case.test_purpose }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>前置條件:</strong>
                                        {{ render_manual_list(case.preconditions) }}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>測試步驟:</strong>
                                        {{ render_manual_list(case.test_steps) }}
                                    </div>
                                     <div class="col-md-6">
                                        <strong>預期結果:</strong>
                                        {{ render_manual_list(case.expected_result) }}
                                    </div>
                                     <div class="col-md-6">
                                        <strong>備註:</strong>
                                        <p style="white-space: pre-wrap; margin-bottom: 0;">{{ case.notes }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>參考資料:</strong>
                                        <p style="white-space: pre-wrap; margin-bottom: 0;">{{ case.reference }}</p>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                {% else %}
                <tbody>
                    <tr>
                        <td colspan="6" class="text-center">找不到符合篩選條件的測試案例。</td>
                    </tr>
                </tbody>
                {% endfor %}
            </table>
        </div>
    </form> 

    {% if pagination and pagination.pages > 1 %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('index', page=pagination.prev_num, product=selected_product, main_category=selected_main_category, sub_category=selected_sub_category) }}">&laquo;</a>
            </li>
            
            {% for page_num in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
                {% if page_num %}
                    <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('index', page=page_num, product=selected_product, main_category=selected_main_category, sub_category=selected_sub_category) }}">{{ page_num }}</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}

            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('index', page=pagination.next_num, product=selected_product, main_category=selected_main_category, sub_category=selected_sub_category) }}">&raquo;</a>
            </li>
        </ul>
    </nav>
    {% endif %}
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('click', function(event) {
                document.querySelectorAll('.case-checkbox').forEach(function(checkbox) {
                    checkbox.checked = event.target.checked;
                });
            });
        }
        const expandAllBtn = document.getElementById('expand-all-btn');
        const collapseAllBtn = document.getElementById('collapse-all-btn');
        const collapsibleElements = Array.from(document.querySelectorAll('tr.collapse')); 
        if (expandAllBtn && collapseAllBtn && collapsibleElements.length > 0) {
            let isProcessing = false;
            function processInBatches(elements, action, batchSize = 20) {
                if (isProcessing) return; 
                isProcessing = true;
                expandAllBtn.disabled = true;
                collapseAllBtn.disabled = true;
                let index = 0;
                function nextBatch() {
                    const batch = elements.slice(index, index + batchSize);
                    if (batch.length === 0) {
                        isProcessing = false; 
                        expandAllBtn.disabled = false;
                        collapseAllBtn.disabled = false;
                        return;
                    }
                    batch.forEach(el => {
                        const bsCollapse = bootstrap.Collapse.getOrCreateInstance(el);
                        if (action === 'show') {
                            bsCollapse.show();
                        } else {
                            bsCollapse.hide();
                        }
                    });
                    index += batchSize;
                    requestAnimationFrame(nextBatch);
                }
                nextBatch();
            }
            expandAllBtn.addEventListener('click', function() {
                processInBatches(collapsibleElements, 'show');
            });
            collapseAllBtn.addEventListener('click', function() {
                processInBatches(collapsibleElements, 'hide');
            });
        }
    });
    </script>
{% endblock %}