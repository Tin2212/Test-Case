{% extends 'base.html' %}

{% macro render_manual_list(text_block) %}
    <div class="manual-list">
        {% for line in (text_block or "").split('\n') if line.strip() %}
        <div class="manual-list-item">
            <span class="manual-list-number">{{ loop.index }}.</span>
            <span class="manual-list-text">{{ line.strip().lstrip('0123456789. ') }}</span>
        </div>
        {% endfor %}
    </div>
{% endmacro %}

{% block page_title %}
    測試案例列表
{% endblock %}

{% block sidebar %}
    <nav class="tree-nav">
        <ul>
            <li>
                <a href="{{ url_for('index') }}" class="{{ 'active-filter' if not selected_product }}">
                    <i class="bi bi-folder-fill me-2"></i>所有產品
                </a>
            </li>
            {% for product, main_categories in tree_data.items()|sort %}
                <li class="parent {% if product == selected_product %}active open{% endif %}">
                    <a href="{{ url_for('index', product=product) }}">
                        {{ product }}
                    </a>
                    <ul class="sub-menu">
                        {% for main_group, sub_groups in main_categories.items()|sort %}
                             <li class="parent {% if product == selected_product and main_group == selected_main_category %}active open{% endif %}">
                                <a href="{{ url_for('index', product=product, main_category=main_group) }}">
                                    {{ main_group.replace('功能', '') }}
                                </a>
                                <ul class="sub-menu">
                                    {% for sub in sub_groups|sort %}
                                        <li>
                                            <a href="{{ url_for('index', product=product, main_category=main_group, sub_category=sub) }}"
                                               class="{{ 'active-filter' if product == selected_product and main_group == selected_main_category and sub == selected_sub_category }}">
                                                 {{ sub }}
                                            </a>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </li>
                        {% endfor %}
                    </ul>
                </li>
            {% endfor %}
        </ul>
    </nav>
{% endblock %}

{% block content %}
    <h4 class="mb-3">
        {% if selected_sub_category %}
            {{ selected_product }} / {{ selected_main_category.replace('功能', '') }} / {{ selected_sub_category }}
        {% elif selected_main_category %}
            {{ selected_product }} / {{ selected_main_category.replace('功能', '') }}
        {% elif selected_product %}
            {{ selected_product }}
        {% else %}
            所有案例
        {% endif %}
        <span class="badge bg-light text-dark ms-2">{{ pagination.total }} 筆</span>
    </h4>

    {% if global_precondition %}
    <div class="alert alert-info" role="alert">
        <h6 class="alert-heading">
            <i class="bi bi-info-circle-fill me-2"></i>
            {% if selected_main_category and (selected_main_category.startswith('Spec#') or selected_main_category.startswith('Tests#')) %}
                {{ selected_main_category }}
            {% else %}
                {{ selected_product }}
            {% endif %}
            - 全域前置條件
        </h6>
        <hr>
        <pre class="mb-0" style="font-family: inherit; font-size: inherit;">{{ global_precondition }}</pre>
    </div>
    {% endif %}

    <form id="bulk-action-form" method="POST">
        
        <div class="sticky-bar">
            <div class="card">
                <div class="card-body">
                    <div class="mb-3">
                        <div class="input-group">
                            <select class="form-control" id="smart-search-select" multiple="multiple">
                                {% for part in query_string.split(' ') if part %}
                                    <option selected="selected">{{ part }}</option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-info" type="button" id="smart-search-btn">
                                <i class="bi bi-search"></i> 搜尋
                            </button>
                        </div>
                        <div class="form-text mt-2">
                             <a tabindex="0"
                               role="button"
                               class="text-decoration-none"
                               data-bs-toggle="popover"
                               data-bs-trigger="hover focus"
                               data-bs-title="智慧搜尋語法說明"
                               data-bs-html="true"
                               data-bs-content="<ul class='list-unstyled mb-0'>
                                                 <li><strong class='text-primary'>1. 搜尋案例:</strong> 直接輸入關鍵字 (例如: <code>登入失敗</code>)</li>
                                                 <li><strong class='text-primary'>2. 搜尋標籤:</strong> 加上 <code>#</code> 符號 (例如: <code>#regression</code>)</li>
                                                 <li><strong class='text-primary'>3. 搜尋狀態:</strong> 加上 <code>status:</code> (例如: <code>status:通過</code>)</li>
                                               </ul>
                                               <hr class='my-2'>
                                               <small>輸入條件後按 <strong>空白鍵</strong> 或 <strong>Enter</strong> 即可建立區塊。</small>">
                                <i class="bi bi-question-circle-fill"></i>
                                <span>搜尋語法說明</span>
                            </a>
                        </div>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center gap-3">
                        <div class="input-group" style="max-width: 400px;">
                            <span class="input-group-text">批量標籤</span>
                            <select id="bulk-tag-select" class="form-select">
                                <option></option>
                                {% for tag in all_tags %}
                                    <option value="{{ tag.name }}">{{ tag.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" id="bulk-add-tag-btn" class="btn btn-primary">套用</button>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <button type="button" id="bulk-delete-btn" class="btn btn-danger">
                                <i class="bi bi-trash-fill"></i> 批量刪除
                            </button>
                            <div class="input-group input-group-sm" style="width: 150px;">
                                <label class="input-group-text" for="per-page-select">每頁顯示</label>
                                <select class="form-select" id="per-page-select">
                                    <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                                    <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                                    <option value="30" {% if per_page == 30 %}selected{% endif %}>30</option>
                                    <option value="40" {% if per_page == 40 %}selected{% endif %}>40</option>
                                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                                </select>
                            </div>
                            <button type="button" id="toggle-all-btn" class="btn btn-outline-secondary btn-sm" data-state="collapsed">
                                <i class="bi bi-arrows-expand"></i> 
                                <span>全部展開</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <input type="hidden" name="product" value="{{ selected_product or '' }}">
        <input type="hidden" name="main_category" value="{{ selected_main_category or '' }}">
        <input type="hidden" name="sub_category" value="{{ selected_sub_category or '' }}">
        <input type="hidden" name="page" value="{{ pagination.page or 1 }}">
        <input type="hidden" name="per_page" value="{{ per_page or 50 }}">
        <input type="hidden" name="q" value="{{ query_string or '' }}">
        
        <div class="table-responsive">
            <table class="table table-hover table-bordered caption-top table-fixed-layout">
                <caption></caption>
                <thead class="table-dark">
                    <tr>
                        <th style="width: 3%;"><input class="form-check-input" type="checkbox" id="select-all-checkbox"></th>
                        <th style="width: 10%;">Case ID / 標籤</th>
                        <th style="width: 20%;">測試項目</th>
                        <th style="width: 32%;">狀態 / 實際結果</th>
                        <th style="width: 25%;">備註</th>
                        <th style="width: 10%;">操作</th>
                    </tr>
                </thead>
                <tbody id="case-table-body">
                {% for case in cases %}
                        <tr class="expandable-row" 
                            data-bs-target="#collapse-{{ case.id }}"
                            data-case-id="{{ case.id }}"
                            style="cursor: pointer;">
                            <td class="text-center align-middle">
                                <input class="form-check-input case-checkbox" type="checkbox" name="case_ids" value="{{ case.id }}">
                            </td>
                            <td>
                                {{ case.case_id }}
                                <div class="tag-list mt-1">
                                    {% for tag in case.tags|sort(attribute='name') %}
                                        <a href="{{ url_for('delete_tag', case_id=case.id, tag_name=tag.name, q=query_string, per_page=per_page, page=pagination.page, product=selected_product, main_category=selected_main_category, sub_category=selected_sub_category) }}"
                                           class="badge bg-secondary text-decoration-none me-1 tag-item"
                                           title="點擊以刪除標籤"
                                           onclick="return confirm('您確定要刪除標籤 \'{{ tag.name }}\' 嗎？');">
                                            {{ tag.name }}
                                        </a>
                                    {% endfor %}
                                </div>
                            </td>
                            <td>{{ case.test_item }}</td>
                            <td>
                                <div id="status-result-wrapper-{{ case.id }}">
                                    {% include 'partials/_status_result_display.html' %}
                                </div>
                            </td>
                            <td>
                                <div id="notes-wrapper-{{ case.id }}">
                                    {% include 'partials/_notes_display.html' %}
                                </div>
                            </td>
                            <td>
                                <div class="dropdown">
                                    <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">操作</button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{{ url_for('edit_case', id=case.id) }}">完整編輯</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <button type="button" class="dropdown-item text-danger"
                                                    hx-post="{{ url_for('delete_case', id=case.id) }}"
                                                    hx-confirm="您確定要刪除這個案例嗎？"
                                                    hx-target="closest tr"
                                                    hx-swap="outerHTML">
                                                刪除
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        
                        <tr id="collapse-{{ case.id }}" class="collapse">
                             <td colspan="6" id="details-content-{{ case.id }}" style="background-color: #f8f9fa; padding: 20px;">
                                <div class="p-3 text-center">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </td>
                        </tr>
                {% else %}
                    <tr>
                        <td colspan="6" class="text-center">找不到符合篩選條件的測試案例。</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </form> 

    {% if pagination and pagination.pages > 1 %}
    {% set base_params = {
        'q': query_string, 
        'per_page': per_page,
        'product': selected_product, 
        'main_category': selected_main_category, 
        'sub_category': selected_sub_category
    } %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('index', page=pagination.prev_num, **base_params) }}">&laquo;</a>
            </li>
            
            {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}
                    {% if page_num == pagination.page %}
                        <li class="page-item active" aria-current="page">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                    {% else %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('index', page=page_num, **base_params) }}">{{ page_num }}</a>
                        </li>
                    {% endif %}
                {% else %}
                    <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
                {% endif %}
            {% endfor %}

            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('index', page=pagination.next_num, **base_params) }}">&raquo;</a>
            </li>
        </ul>
    </nav>
    {% endif %}
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Helper function to introduce a small delay ---
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // --- Single row expansion/collapse logic ---
    const tableBody = document.getElementById('case-table-body');
    if (tableBody) {
        tableBody.addEventListener('click', function(e) {
            const interactiveElement = e.target.closest(
                'a, button, input, select, textarea, .dropdown, .case-checkbox, .tag-item, .editable-section'
            );
            if (interactiveElement) {
                return;
            }

            const expandableRow = e.target.closest('.expandable-row');
            if (expandableRow) {
                const targetId = expandableRow.dataset.bsTarget;
                const collapseElement = document.querySelector(targetId);

                if (collapseElement) {
                    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseElement);
                    bsCollapse.toggle();

                    const detailsContent = document.querySelector(targetId + ' > td');
                    if (!detailsContent.hasAttribute('data-loaded')) {
                        const caseId = expandableRow.dataset.caseId;
                        const detailUrl = "{{ url_for('get_case_details', id=0) }}".replace('0', caseId);

                        htmx.ajax('GET', detailUrl, { target: detailsContent, swap: 'innerHTML' }).then(() => {
                            detailsContent.setAttribute('data-loaded', 'true');
                        });
                    }
                }
            }
        });
    }

    // --- Smart search logic ---
    $('#smart-search-select').select2({
        theme: 'bootstrap-5',
        tags: true,
        placeholder: '輸入條件後按 Enter 或空白鍵建立區塊...',
        tokenSeparators: [' ', ',']
    });
    const searchBtn = document.getElementById('smart-search-btn');
    if (searchBtn) {
        const performSearch = function() {
            const selectedData = $('#smart-search-select').val();
            const queryString = selectedData ? selectedData.join(' ') : '';
            const currentUrl = new URL(window.location.href);
            if (queryString) {
                currentUrl.searchParams.set('q', queryString);
            } else {
                currentUrl.searchParams.delete('q');
            }
            currentUrl.searchParams.set('page', '1'); // Reset to first page on new search
            window.location.href = currentUrl.href;
        };
        searchBtn.addEventListener('click', performSearch);
        $('#smart-search-select').next('.select2-container').on('keyup', function(event) {
            if (event.key === 'Enter') {
                setTimeout(performSearch, 50);
            }
        });
    }

    // --- Bulk actions logic (Tags & Delete) ---
    // ▼▼▼ 核心修改處：移除 tokenSeparators 中的空格 ▼▼▼
    $('#bulk-tag-select').select2({ 
        theme: 'bootstrap-5', 
        placeholder: '選擇或輸入新標籤...', 
        tags: true, 
        tokenSeparators: [','] 
    });
    // ▲▲▲ 修改結束 ▲▲▲
    const bulkForm = document.getElementById('bulk-action-form');
    const addTagBtn = document.getElementById('bulk-add-tag-btn');
    const deleteBtn = document.getElementById('bulk-delete-btn');
    if (bulkForm && addTagBtn && deleteBtn) {
        addTagBtn.addEventListener('click', function() {
            const tagValue = $('#bulk-tag-select').val();
            if (!tagValue) { alert('請選擇或輸入要新增的標籤！'); return; }
            let hiddenInput = bulkForm.querySelector('input[name="new_tag"]');
            if (!hiddenInput) {
                hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'new_tag';
                bulkForm.appendChild(hiddenInput);
            }
            hiddenInput.value = tagValue;
            bulkForm.action = "{{ url_for('bulk_add_tag') }}";
            bulkForm.submit();
        });

        deleteBtn.addEventListener('click', function() {
            const checkedBoxes = bulkForm.querySelectorAll('input[name="case_ids"]:checked');
            if (checkedBoxes.length === 0) {
                alert('請至少選擇一個要刪除的案例！');
                return;
            }
            if (confirm('您確定要刪除所選的 ' + checkedBoxes.length + ' 個案例嗎？此操作無法復原。')) {
                bulkForm.action = "{{ url_for('bulk_delete') }}";
                bulkForm.submit();
            }
        });
    }

    // --- Per page selection logic ---
    const perPageSelect = document.getElementById('per-page-select');
    if (perPageSelect) {
        perPageSelect.addEventListener('change', function() {
            const perPage = this.value;
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('per_page', perPage);
            currentUrl.searchParams.set('page', '1'); // Reset to first page
            window.location.href = currentUrl.href;
        });
    }

    // --- Select all checkbox logic ---
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('click', function(event) {
            document.querySelectorAll('.case-checkbox').forEach(function(checkbox) {
                checkbox.checked = event.target.checked;
            });
        });
    }

    // --- "Toggle All" expand/collapse logic ---
    const toggleAllBtn = document.getElementById('toggle-all-btn');
    if (toggleAllBtn) {
        // Use an async function to allow for 'await'
        toggleAllBtn.addEventListener('click', async function() {
            const button = this;
            const isCollapsed = button.dataset.state === 'collapsed';
            const action = isCollapsed ? 'show' : 'hide';
            const expandableRows = document.querySelectorAll('.expandable-row');

            button.disabled = true;
            const originalText = button.querySelector('span').textContent;
            button.querySelector('span').textContent = '處理中...';

            if (action === 'show') {
                for (const row of expandableRows) {
                    const targetId = row.dataset.bsTarget;
                    const collapseElement = document.querySelector(targetId);
                    const detailsContent = document.querySelector(targetId + ' > td');

                    if (collapseElement && detailsContent) {
                        if (!detailsContent.hasAttribute('data-loaded')) {
                            const caseId = row.dataset.caseId;
                            const detailUrl = "{{ url_for('get_case_details', id=0) }}".replace('0', caseId);
                            await htmx.ajax('GET', detailUrl, { target: detailsContent, swap: 'innerHTML' });
                            detailsContent.setAttribute('data-loaded', 'true');
                        }
                        const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseElement);
                        bsCollapse.show();
                        await sleep(20);
                    }
                }
            } else { // action === 'hide'
                for (const row of expandableRows) {
                    const targetId = row.dataset.bsTarget;
                    const collapseElement = document.querySelector(targetId);
                    if (collapseElement) {
                        const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseElement);
                        bsCollapse.hide();
                    }
                }
                await sleep(50);
            }

            // --- Update button state and re-enable it ---
            const icon = button.querySelector('i');
            const text = button.querySelector('span');
            button.dataset.state = isCollapsed ? 'expanded' : 'collapsed';
            
            if (isCollapsed) {
                icon.classList.remove('bi-arrows-expand');
                icon.classList.add('bi-arrows-collapse');
                text.textContent = '全部收合';
            } else {
                icon.classList.remove('bi-arrows-collapse');
                icon.classList.add('bi-arrows-expand');
                text.textContent = '全部展開';
            }
            button.disabled = false;
        });
    }

    // --- Popover initialization ---
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
      return new bootstrap.Popover(popoverTriggerEl)
    });
});
</script>
{% endblock %}