{% extends 'base.html' %}

{% macro render_manual_list(text_block) %}
    <div class="manual-list">
        {% for line in (text_block or "").split('\n') if line.strip() %}
        <div class="manual-list-item">
            <span class="manual-list-number">{{ loop.index }}.</span>
            <span class="manual-list-text">{{ line.strip().lstrip('0123456789. ') }}</span>
        </div>
        {% endfor %}
    </div>
{% endmacro %}

{% block page_title %}
    測試案例列表
{% endblock %}

{% block sidebar %}
    <nav class="tree-nav">
        <ul>
            <li>
                <a href="{{ url_for('index') }}" class="{{ 'active-filter' if not selected_product }}">
                    <i class="bi bi-folder-fill me-2"></i>所有產品
                </a>
            </li>
            {% for product, main_categories in tree_data.items()|sort %}
                <li class="parent {% if product == selected_product %}active open{% endif %}">
                    <a href="{{ url_for('index', product=product) }}">
                        {{ product }}
                    </a>
                    <ul class="sub-menu">
                        {% for main_group, sub_groups in main_categories.items()|sort %}
                             <li class="parent {% if product == selected_product and main_group == selected_main_category %}active open{% endif %}">
                                <a href="{{ url_for('index', product=product, main_category=main_group) }}">
                                    {{ main_group.replace('功能', '') }}
                                </a>
                                <ul class="sub-menu">
                                    {% for sub in sub_groups|sort %}
                                        <li>
                                            <a href="{{ url_for('index', product=product, main_category=main_group, sub_category=sub) }}"
                                               class="{{ 'active-filter' if product == selected_product and main_group == selected_main_category and sub == selected_sub_category }}">
                                                {{ sub }}
                                            </a>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </li>
                        {% endfor %}
                    </ul>
                </li>
            {% endfor %}
        </ul>
    </nav>
{% endblock %}

{% block content %}
    <h4 class="mb-3">
        {% if selected_sub_category %}
            {{ selected_product }} / {{ selected_main_category.replace('功能', '') }} / {{ selected_sub_category }}
        {% elif selected_main_category %}
            {{ selected_product }} / {{ selected_main_category.replace('功能', '') }}
        {% elif selected_product %}
            {{ selected_product }}
        {% else %}
            所有案例
        {% endif %}
        <span class="badge bg-light text-dark ms-2">{{ pagination.total }} 筆</span>
    </h4>

    {% if global_precondition %}
    <div class="alert alert-info" role="alert">
        <h6 class="alert-heading">
            <i class="bi bi-info-circle-fill me-2"></i>{{ selected_product }} - 全域前置條件
        </h6>
        <hr>
        <pre class="mb-0" style="font-family: inherit; font-size: inherit;">{{ global_precondition }}</pre>
    </div>
    {% endif %}

    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-auto">
                    <label class="form-label mb-0"><strong><i class="bi bi-flag-fill me-1"></i>依狀態：</strong></label>
                </div>
                <div class="col">
                    <div class="btn-group btn-group-sm" role="group">
                        {% for status in status_options %}
                        <a href="#" class="btn btn-outline-secondary filter-btn status-filter {% if status in selected_statuses %}active{% endif %}" data-filter-type="status" data-filter-value="{{ status }}">
                            {{ status }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-auto">
                     <label for="tag-filter-select" class="form-label mb-0"><strong><i class="bi bi-tags-fill me-1"></i>依標籤：</strong></label>
                </div>
                <div class="col-md-4">
                    <select id="tag-filter-select" class="form-select form-select-sm" multiple>
                        {% for tag in all_tags %}
                            <option value="{{ tag.name }}" {% if tag.name in selected_tags %}selected{% endif %}>{{ tag.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>


    <form id="bulk-action-form" method="POST">
        
        <div class="sticky-bar">
            <div class="card">
                <div class="card-body d-flex justify-content-between align-items-center gap-3">
                    <div class="input-group" style="max-width: 400px;">
                        <span class="input-group-text">標籤</span>
                        <input type="text" name="new_tag" class="form-control" placeholder="為選取項目新增標籤...">
                        <button type="button" id="bulk-add-tag-btn" class="btn btn-primary">套用</button>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <button type="button" id="bulk-delete-btn" class="btn btn-danger">
                            <i class="bi bi-trash-fill"></i> 批量刪除
                        </button>
                        
                        <div class="input-group input-group-sm" style="width: 150px;">
                          <label class="input-group-text" for="per-page-select">每頁顯示</label>
                          <select class="form-select" id="per-page-select">
                            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                            <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                            <option value="30" {% if per_page == 30 %}selected{% endif %}>30</option>
                            <option value="40" {% if per_page == 40 %}selected{% endif %}>40</option>
                            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                          </select>
                        </div>

                        <button type="button" id="toggle-all-btn" class="btn btn-outline-secondary btn-sm" data-state="collapsed">
                            <i class="bi bi-arrows-expand"></i> 
                            <span>全部展開</span>
                        </button>

                    </div>
                </div>
            </div>
        </div>
        
        <input type="hidden" name="product" value="{{ selected_product or '' }}">
        <input type="hidden" name="main_category" value="{{ selected_main_category or '' }}">
        <input type="hidden" name="sub_category" value="{{ selected_sub_category or '' }}">
        <input type="hidden" name="page" value="{{ pagination.page or 1 }}">
        <input type="hidden" name="per_page" value="{{ per_page or 50 }}">
        
        <div class="table-responsive">
            <table class="table table-hover table-bordered caption-top table-fixed-layout">
                <caption></caption>
                <thead class="table-dark">
                    <tr>
                        <th style="width: 3%;"><input class="form-check-input" type="checkbox" id="select-all-checkbox"></th>
                        <th style="width: 10%;">Case ID / 標籤</th>
                        <th style="width: 20%;">測試項目</th>
                        <th style="width: 32%;">狀態 / 實際結果</th>
                        <th style="width: 25%;">備註</th>
                        <th style="width: 10%;">操作</th>
                    </tr>
                </thead>
                {% for case in cases %}
                    <tbody class="case-group">
                        <tr class="expandable-row" data-bs-target="#collapse-{{ case.id }}" style="cursor: pointer;">
                            <td class="text-center align-middle">
                                <input class="form-check-input case-checkbox" type="checkbox" name="case_ids" value="{{ case.id }}">
                            </td>
                            <td>
                                {{ case.case_id }}
                                {% include 'partials/_tags_display.html' %}
                            </td>
                            <td>{{ case.test_item }}</td>
                            <td>
                                <div id="status-result-wrapper-{{ case.id }}">
                                    {% include 'partials/_status_result_display.html' %}
                                </div>
                            </td>
                            <td>
                                <div id="notes-wrapper-{{ case.id }}">
                                    {% include 'partials/_notes_display.html' %}
                                </div>
                            </td>
                            <td>
                                <div class="dropdown">
                                    <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">操作</button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{{ url_for('edit_case', id=case.id) }}">完整編輯</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <button type="button" class="dropdown-item text-danger"
                                                    hx-post="{{ url_for('delete_case', id=case.id) }}"
                                                    hx-confirm="您確定要刪除這個案例嗎？"
                                                    hx-target="closest .case-group"
                                                    hx-swap="outerHTML">
                                                刪除
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        
                        <tr id="collapse-{{ case.id }}" class="collapse">
                           <td colspan="6" style="background-color: #f8f9fa; padding: 20px;">
                                <div class="row g-3">
                                     <div class="col-md-6">
                                        <strong>測試目的:</strong>
                                        <p style="white-space: pre-wrap; margin-bottom: 0;">{{ case.test_purpose }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>前置條件:</strong>
                                        {{ render_manual_list(case.preconditions) }}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>測試步驟:</strong>
                                        {{ render_manual_list(case.test_steps) }}
                                    </div>
                                     <div class="col-md-6">
                                        <strong>預期結果:</strong>
                                        <p style="white-space: pre-wrap; margin-bottom: 0;">{{ case.expected_result }}</p>
                                    </div>
                                     <div class="col-md-6">
                                        <strong>備註:</strong>
                                        <p style="white-space: pre-wrap; margin-bottom: 0;">{{ case.notes }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>參考資料:</strong>
                                        <p style="white-space: pre-wrap; margin-bottom: 0;">{{ case.reference }}</p>
                                    </div>
                                    
                                    {% if case.attachments %}
                                    <div class="col-md-12">
                                        <strong>附件:</strong>
                                        <div class="d-flex flex-wrap align-items-start">
                                        {% for attachment in case.attachments %}
                                            {% set extensions = ['.png', '.jpg', '.jpeg', '.gif', '.bmp', '.webp'] %}
                                            {% set is_image = false %}
                                            {% for ext in extensions %}
                                                {% if attachment.filename.lower().endswith(ext) %}
                                                    {% set is_image = true %}
                                                {% endif %}
                                            {% endfor %}

                                            {% if is_image %}
                                                <div class="me-3 mb-3 text-center" style="max-width: 300px;">
                                                    <a href="{{ url_for('download_attachment', filename=attachment.filepath) }}" class="d-block mb-1 small" title="下載檔案">{{ attachment.filename }}</a>
                                                    <a href="{{ url_for('serve_attachment', filename=attachment.filepath) }}" target="_blank">
                                                        <img src="{{ url_for('serve_attachment', filename=attachment.filepath) }}" class="img-fluid rounded border" style="max-height: 200px;">
                                                    </a>
                                                </div>
                                            {% else %}
                                                <a href="{{ url_for('download_attachment', filename=attachment.filepath) }}" class="btn btn-outline-secondary btn-sm me-2 mb-2" title="{{ attachment.filename }}">
                                                    <i class="bi bi-download me-1"></i> {{ attachment.filename|truncate(30) }}
                                                </a>
                                            {% endif %}
                                        {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>

                    </tbody>
                {% else %}
                <tbody>
                    <tr>
                        <td colspan="6" class="text-center">找不到符合篩選條件的測試案例。</td>
                    </tr>
                </tbody>
                {% endfor %}
            </table>
        </div>
    </form> 

    {% if pagination and pagination.pages > 1 %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('index', page=pagination.prev_num, product=selected_product, main_category=selected_main_category, sub_category=selected_sub_category, per_page=per_page) }}&{{ request.args.to_dict()|urlencode }}">&laquo;</a>
            </li>
            
            {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}
                    {% if page_num == pagination.page %}
                        <li class="page-item active" aria-current="page">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                    {% else %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('index', page=page_num, product=selected_product, main_category=selected_main_category, sub_category=selected_sub_category, per_page=per_page) }}&{{ request.args.to_dict()|urlencode }}">{{ page_num }}</a>
                        </li>
                    {% endif %}
                {% else %}
                    <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
                {% endif %}
            {% endfor %}

            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('index', page=pagination.next_num, product=selected_product, main_category=selected_main_category, sub_category=selected_sub_category, per_page=per_page) }}&{{ request.args.to_dict()|urlencode }}">&raquo;</a>
            </li>
        </ul>
    </nav>
    {% endif %}
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('bulk-action-form');
        const addTagBtn = document.getElementById('bulk-add-tag-btn');
        const deleteBtn = document.getElementById('bulk-delete-btn');

        if (form && addTagBtn && deleteBtn) {
            addTagBtn.addEventListener('click', function() {
                const tagInput = form.querySelector('input[name="new_tag"]');
                if (!tagInput.value.trim()) {
                    alert('請輸入要新增的標籤！');
                    tagInput.focus();
                    return;
                }
                form.action = "{{ url_for('bulk_add_tag') }}";
                form.submit();
            });

            deleteBtn.addEventListener('click', function() {
                const checkedBoxes = form.querySelectorAll('input[name="case_ids"]:checked');
                if (checkedBoxes.length === 0) {
                    alert('請至少選擇一個要刪除的案例！');
                    return;
                }

                if (confirm('您確定要刪除所選的 ' + checkedBoxes.length + ' 個案例嗎？此操作無法復原。')) {
                    form.action = "{{ url_for('bulk_delete') }}";
                    form.submit();
                }
            });
        }
        
        const perPageSelect = document.getElementById('per-page-select');
        if (perPageSelect) {
            perPageSelect.addEventListener('change', function() {
                const perPage = this.value;
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('per_page', perPage);
                currentUrl.searchParams.set('page', '1');
                window.location.href = currentUrl.href;
            });
        }
        
        const statusFilterBtns = document.querySelectorAll('.status-filter');
        statusFilterBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const currentUrl = new URL(window.location.href);
                const filterValue = this.dataset.filterValue;
                const filterType = 'status';

                if (this.classList.contains('active')) {
                    currentUrl.searchParams.delete(filterType);
                } else {
                    currentUrl.searchParams.set(filterType, filterValue);
                }
                
                currentUrl.searchParams.set('page', '1');
                window.location.href = currentUrl.href;
            });
        });

        $('#tag-filter-select').select2({
            theme: 'bootstrap-5',
            placeholder: '選擇一或多個標籤...'
        }).on('change', function() {
            const selectedTags = $(this).val();
            const currentUrl = new URL(window.location.href);
            
            currentUrl.searchParams.delete('tag');
            selectedTags.forEach(tag => {
                currentUrl.searchParams.append('tag', tag);
            });

            currentUrl.searchParams.set('page', '1');
            window.location.href = currentUrl.href;
        });


        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('click', function(event) {
                document.querySelectorAll('.case-checkbox').forEach(function(checkbox) {
                    checkbox.checked = event.target.checked;
                });
            });
        }
        
        const toggleAllBtn = document.getElementById('toggle-all-btn');
        const collapsibleElements = Array.from(document.querySelectorAll('tr.collapse')); 
        
        if (toggleAllBtn && collapsibleElements.length > 0) {
            let isProcessing = false;
            function processInBatches(elements, action, batchSize = 20) {
                if (isProcessing) return; 
                isProcessing = true;
                toggleAllBtn.disabled = true;
                let index = 0;
                function nextBatch() {
                    const batch = elements.slice(index, index + batchSize);
                    if (batch.length === 0) {
                        isProcessing = false; 
                        toggleAllBtn.disabled = false;
                        return;
                    }
                    batch.forEach(el => {
                        const bsCollapse = bootstrap.Collapse.getOrCreateInstance(el);
                        if (action === 'show') {
                            bsCollapse.show();
                        } else {
                            bsCollapse.hide();
                        }
                    });
                    index += batchSize;
                    requestAnimationFrame(nextBatch);
                }
                nextBatch();
            }
            
            toggleAllBtn.addEventListener('click', function() {
                const currentState = this.dataset.state;
                const icon = this.querySelector('i');
                const text = this.querySelector('span');

                if (currentState === 'collapsed') {
                    processInBatches(collapsibleElements, 'show');
                    this.dataset.state = 'expanded';
                    icon.classList.remove('bi-arrows-expand');
                    icon.classList.add('bi-arrows-collapse');
                    text.textContent = '全部收合';
                } else {
                    processInBatches(collapsibleElements, 'hide');
                    this.dataset.state = 'collapsed';
                    icon.classList.remove('bi-arrows-collapse');
                    icon.classList.add('bi-arrows-expand');
                    text.textContent = '全部展開';
                }
            });
        }
    });
    </script>
{% endblock %}