<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>{{ title or '測試案例管理系統' }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        body { display: flex; background-color: #f8f9fa; }
        #sidebar { width: 280px; flex-shrink: 0; min-height: 100vh; background: #fff; padding: 1.5rem; box-shadow: 2px 0 5px rgba(0,0,0,0.1); transition: margin-left 0.3s ease-in-out; }
        #content { flex-grow: 1; padding: 2rem; width: calc(100% - 280px); transition: width 0.3s ease-in-out; }
        body.sidebar-collapsed #sidebar { margin-left: -280px; }
        body.sidebar-collapsed #content { width: 100%; }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .sidebar-header .btn { color: #6c757d; }
        .sidebar-header .btn.active, .sidebar-header .btn:hover { color: #000; }
        .tree-nav ul { list-style-type: none; padding-left: 0; }
        .tree-nav li a { display: block; padding: 0.5rem 1rem; text-decoration: none; color: #333; border-radius: 0.25rem; }
        .tree-nav li a:hover { background-color: #f0f0f0; }
        .tree-nav .sub-menu { padding-left: 1.5rem; display: none; }
        .tree-nav .parent.active > .sub-menu { display: block; }
        .tree-nav .parent > a::before { content: '\F286'; font-family: 'bootstrap-icons'; margin-right: 0.5rem; transition: transform 0.2s ease; }
        .tree-nav .parent.active > a::before { transform: rotate(90deg); }
        .tree-nav .active-filter { background-color: #0d6efd; color: white !important; }
        #content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .tag-removable { cursor: pointer; transition: background-color 0.2s ease-in-out; }
        .tag-removable:hover { background-color: #dc3545 !important; color: white; }
    </style>
</head>
<body>
    <aside id="sidebar">
        <div class="sidebar-header">
            <h4>篩選器</h4>
            <button id="pin-sidebar-btn" class="btn btn-sm" title="釘選/取消釘選"><i class="bi bi-pin-angle"></i></button>
        </div>
        {% block sidebar %}{% endblock %}
    </aside>

    <main id="content">
        <header id="content-header">
            <div class="d-flex align-items-center">
                <button id="toggle-sidebar-btn" class="btn btn-lg me-3" title="收合/展開側邊欄"><i class="bi bi-list"></i></button>
                <h3>{% block page_title %}{% endblock %}</h3>
            </div>
            <nav>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary">案例列表</a>
                <a href="{{ url_for('add_case') }}" class="btn btn-primary">新增案例</a>
                <a href="{{ url_for('upload_page') }}" class="btn btn-outline-secondary">從 Excel 匯入</a>
            </nav>
        </header>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}{% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}{% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const body = document.body;
        
        // --- 側邊欄釘選與收合邏輯 (維持不變) ---
        const toggleBtn = document.getElementById('toggle-sidebar-btn');
        const pinBtn = document.getElementById('pin-sidebar-btn');
        if (toggleBtn && pinBtn) {
            const pinIcon = pinBtn.querySelector('i');
            function updatePinIcon(isPinned) {
                if (isPinned) {
                    pinIcon.classList.remove('bi-pin-angle'); pinIcon.classList.add('bi-pin-angle-fill');
                    pinBtn.classList.add('active');
                } else {
                    pinIcon.classList.remove('bi-pin-angle-fill'); pinIcon.classList.add('bi-pin-angle');
                    pinBtn.classList.remove('active');
                }
            }
            toggleBtn.addEventListener('click', () => {
                if (!body.classList.contains('sidebar-pinned')) {
                    body.classList.toggle('sidebar-collapsed');
                    localStorage.setItem('sidebarCollapsed', body.classList.contains('sidebar-collapsed'));
                }
            });
            pinBtn.addEventListener('click', () => {
                const isPinned = body.classList.toggle('sidebar-pinned');
                localStorage.setItem('sidebarPinned', isPinned);
                updatePinIcon(isPinned);
                if (isPinned) {
                    body.classList.remove('sidebar-collapsed');
                    localStorage.setItem('sidebarCollapsed', 'false');
                }
            });
            const isPinnedOnLoad = localStorage.getItem('sidebarPinned') === 'true';
            if (isPinnedOnLoad) body.classList.add('sidebar-pinned');
            updatePinIcon(isPinnedOnLoad);
            const isCollapsedOnLoad = localStorage.getItem('sidebarCollapsed') === 'true';
            if (isCollapsedOnLoad && !isPinnedOnLoad) body.classList.add('sidebar-collapsed');
        }
        
        // --- 樹狀選單展開/收合邏輯 (維持不變) ---
        document.querySelectorAll('.tree-nav .parent > a').forEach(item => {
            item.addEventListener('click', event => {
                event.preventDefault(); 
                item.parentElement.classList.toggle('active');
            });
        });

        // --- 【重要修正】使用事件代理來處理所有點擊衝突 ---
        const table = document.querySelector('table');
        if(table) {
            table.addEventListener('click', function(event) {
                const expandableRow = event.target.closest('.expandable-row');
                if (!expandableRow) return;

                // 【修正】將 select 和 textarea 加入豁免清單
                if (event.target.closest('a, button, input, select, textarea, .dropdown, [hx-get], [hx-post]')) {
                    return; // 如果點擊的是這些互動元件，就什麼都不做
                }

                // 如果點擊的不是互動元件，才觸發展開/收合
                const targetId = expandableRow.dataset.bsTarget;
                const collapseElement = document.querySelector(targetId);
                if (collapseElement) {
                    const bsCollapse = new bootstrap.Collapse(collapseElement, {
                        toggle: false
                    });
                    bsCollapse.toggle();
                }
            });
        }
    });
</script>
</body>
</html>