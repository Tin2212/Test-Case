<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>{{ title or '測試案例管理系統' }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        body { display: flex; background-color: #f8f9fa; }
        #sidebar { width: 280px; flex-shrink: 0; min-height: 100vh; background: #fff; padding: 1.5rem; box-shadow: 2px 0 5px rgba(0,0,0,0.1); transition: margin-left 0.3s ease-in-out; }
        #content { flex-grow: 1; padding: 2rem; width: calc(100% - 280px); transition: width 0.3s ease-in-out, margin-left 0.3s ease-in-out; }
        
        body.sidebar-collapsed #sidebar { margin-left: -280px; }
        body.sidebar-collapsed #content { width: 100%; }
        
        body.no-sidebar-page #sidebar { display: none; }
        body.no-sidebar-page #content { width: 100%; margin-left: 0; }
        body.no-sidebar-page #toggle-sidebar-btn { display: none; }

        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .sidebar-header .btn { color: #6c757d; }
        .sidebar-header .btn.active, .sidebar-header .btn:hover { color: #000; }
        .tree-nav ul { list-style-type: none; padding-left: 0; }
        .tree-nav li a { display: block; padding: 0.5rem 1rem; text-decoration: none; color: #333; border-radius: 0.25rem; }
        .tree-nav li a:hover { background-color: #f0f0f0; }
        .tree-nav .sub-menu { padding-left: 1.5rem; display: none; }
        .tree-nav .parent.active > .sub-menu, .tree-nav .parent.open > .sub-menu { display: block; }
        .tree-nav .parent > a::before { content: '\F286'; font-family: 'bootstrap-icons'; margin-right: 0.5rem; transition: transform 0.2s ease; }
        .tree-nav .parent.active > a::before, .tree-nav .parent.open > a::before { transform: rotate(90deg); }
        .tree-nav .active-filter { background-color: #0d6efd; color: white !important; }
        #content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .tag-removable { cursor: pointer; transition: background-color 0.2s ease-in-out; }
        .tag-removable:hover { background-color: #dc3545 !important; color: white; }

        .cell-edit-trigger { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; height: 100%; }
        .cell-edit-trigger p { margin-bottom: 0; flex-grow: 1; padding-right: 10px; }
        .cell-edit-trigger .btn { flex-shrink: 0; width: 80px; }
        .sticky-bar {position: sticky;top: 0; /* 讓它黏在父容器的最頂部 */z-index: 1020; /* 確保它顯示在表格內容的上方 */background-color: #f8f9fa; /* 給它一個和背景一樣的顏色，避免表格內容透出來 */padding-bottom: 1rem; /* 增加一點底部間距，讓它和表格不要黏太近 */margin-bottom: -1rem; /* 抵銷掉 card 預設的 margin-bottom，讓視覺更協調 */}
    </style>
</head>

<body class="{{ 'no-sidebar-page' if hide_sidebar else '' }}">
    <aside id="sidebar">
        {% if not hide_sidebar %}
            <div class="sidebar-header">
                <h4>篩選器</h4>
                <button id="pin-sidebar-btn" class="btn btn-sm" title="釘選/取消釘選"><i class="bi bi-pin-angle"></i></button>
            </div>
        {% endif %}
        {% block sidebar %}{% endblock %}
    </aside>

    <main id="content">
        <header id="content-header">
            <div class="d-flex align-items-center">
                {% if not hide_sidebar %}
                    <button id="toggle-sidebar-btn" class="btn btn-lg me-3" title="收合/展開側邊欄"><i class="bi bi-list"></i></button>
                {% endif %}
                <h3>{% block page_title %}{% endblock %}</h3>
            </div>
            <nav>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary">案例列表</a>
                <a href="{{ url_for('add_case') }}" class="btn btn-primary">新增案例</a>
                <a href="{{ url_for('upload_page') }}" class="btn btn-outline-secondary">從 Excel 匯入</a>
            </nav>
        </header>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}{% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}{% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const body = document.body;
        
        const toggleBtn = document.getElementById('toggle-sidebar-btn');
        const pinBtn = document.getElementById('pin-sidebar-btn');
        if (toggleBtn && pinBtn) {
            // ... (側邊欄釘選與收合邏輯維持不變)
            const pinIcon = pinBtn.querySelector('i');
            function updatePinIcon(isPinned) {
                if (isPinned) {
                    pinIcon.classList.remove('bi-pin-angle'); pinIcon.classList.add('bi-pin-angle-fill');
                    pinBtn.classList.add('active');
                } else {
                    pinIcon.classList.remove('bi-pin-angle-fill'); pinIcon.classList.add('bi-pin-angle');
                    pinBtn.classList.remove('active');
                }
            }
            toggleBtn.addEventListener('click', () => {
                if (!body.classList.contains('sidebar-pinned')) {
                    body.classList.toggle('sidebar-collapsed');
                    localStorage.setItem('sidebarCollapsed', body.classList.contains('sidebar-collapsed'));
                }
            });
            pinBtn.addEventListener('click', () => {
                const isPinned = body.classList.toggle('sidebar-pinned');
                localStorage.setItem('sidebarPinned', isPinned);
                updatePinIcon(isPinned);
                if (isPinned) {
                    body.classList.remove('sidebar-collapsed');
                    localStorage.setItem('sidebarCollapsed', 'false');
                }
            });
            const isPinnedOnLoad = localStorage.getItem('sidebarPinned') === 'true';
            if (isPinnedOnLoad) body.classList.add('sidebar-pinned');
            updatePinIcon(isPinnedOnLoad);
            const isCollapsedOnLoad = localStorage.getItem('sidebarCollapsed') === 'true';
            if (isCollapsedOnLoad && !isPinnedOnLoad) body.classList.add('sidebar-collapsed');
        }
        
        document.querySelectorAll('.tree-nav .parent > a').forEach(item => {
            item.addEventListener('click', event => {
                if (event.target.tagName === 'A') {
                    window.location.href = event.target.href;
                    return;
                }
                event.preventDefault(); 
                item.parentElement.classList.toggle('open');
            });
        });

        const table = document.querySelector('table');
        if(table) {
            table.addEventListener('click', function(event) {
                const expandableRow = event.target.closest('.expandable-row');
                if (!expandableRow) return;

                if (event.target.closest('a, button, input, select, textarea, .dropdown, [hx-get], [hx-post]')) {
                    return; 
                }

                const targetId = expandableRow.dataset.bsTarget;
                const collapseElement = document.querySelector(targetId);
                if (collapseElement) {
                    // --- 核心修正點：優化單次點擊的處理方式 ---
                    // 使用 .getOrCreateInstance()，如果物件已存在就直接取用，不存在才建立
                    // 這比每次都 new 一個新物件的效能更好
                    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseElement);
                    bsCollapse.toggle();
                }
            });
        }
    });
    </script>
</body>
</html>